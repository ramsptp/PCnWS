<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Your Dashboard</title>
</head>
<body>
    <div style="float: right;">
        Welcome, <strong sec:authentication="name">User</strong>!
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <button type="submit">Logout</button>
        </form>
    </div>

    <h1>Welcome to Your Plant Dashboard</h1>
    
    <div style="background-color: #ffcccc; border: 1px solid red; padding: 10px;">
        <h2>Overdue Tasks!</h2>
        <ul th:if="${!overdueTasks.isEmpty()}">
            <li th:each="task : ${overdueTasks}">
                <strong th:text="${task.plant.plantName}">Plant Name</strong>: 
                <span th:text="${task.taskType}">Task Type</span>
                - was due on <span th:text="${task.dueDate}">Due Date</span>
                <a th:href="@{/complete-task/{id}(id=${task.taskId})}">Complete Now</a>
            </li>
        </ul>
        <p th:if="${overdueTasks.isEmpty()}">No overdue tasks. Great job!</p>
    </div>

    <hr>
    
    <h2>Your Plants</h2>
    <a href="/add-plant">Add a New Plant</a>
    
    <ul style="list-style-type: none; padding: 0;">
        <li th:each="plant : ${plants}" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; display: flex; align-items: center;">
            
            <div style="margin-right: 15px;">
                <img th:if="${plant.imageUrl != null and plant.imageUrl != ''}" th:src="${plant.imageUrl}" alt="Plant" style="width: 100px; height: 100px; object-fit: cover;"/>
                <div th:if="${plant.imageUrl == null or plant.imageUrl == ''}" style="width: 100px; height: 100px; background-color: #eee; display: flex; align-items: center; justify-content: center;">
                    <span>No Image</span>
                </div>
            </div>

            <div>
                <strong th:text="${plant.plantName}" style="font-size: 1.2em;">Plant Name</strong>
                (<span th:text="${plant.plantType}">Plant Type</span>)
                <br/>
                Water every <span th:text="${plant.wateringFrequencyDays}">X</span> days
                <br/>
                <a th:href="@{/edit-plant/{id}(id=${plant.plantId})}" style="color: blue;">[Edit]</a>
                <a th:href="@{/delete-plant/{id}(id=${plant.plantId})}"
                   onclick="return confirm('Are you sure you want to delete this plant?');"
                   style="color: red; margin-left: 10px;">
                  [Delete]
                </a>
            </div>
        </li>
    </ul>

    <hr>

    <h2>Upcoming Tasks</h2>
    <ul>
        <li th:each="task : ${tasks}" th:if="${!task.isCompleted}">
            <strong th:text="${task.plant.plantName}">Plant Name</strong>: 
            <span th:text="${task.taskType}">Task Type</span>
            - due on <span th:text="${task.dueDate}">Due Date</span>
            <a th:href="@{/complete-task/{id}(id=${task.taskId})}">Complete</a>
        </li>
    </ul>

    <script>
        function requestNotificationPermission() {
            // Ask the user for permission to send notifications
            if (Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        function showPlantReminders(tasks) {
            if (tasks.length === 0 || Notification.permission !== "granted") {
                return; // Nothing to show or permission denied
            }

            tasks.forEach(task => {
                const title = "ðŸŒ± Plant Care Reminder: " + task.plant.plantName;
                const body = `${task.taskType} is due today, ${task.dueDate}.`;

                new Notification(title, { body: body });
            });
        }

        // --- Main Logic ---

        // 1. Ask for permission immediately when the user loads the page
        requestNotificationPermission();

        // 2. We'll use a timer to run this check once after the page loads.
        setTimeout(() => {
            fetch('/api/due-tasks')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(tasks => {
                    // 3. Display notifications for the fetched tasks
                    showPlantReminders(tasks);
                })
                .catch(error => {
                    console.error('Error fetching reminders:', error);
                });
        }, 3000); // Wait 3 seconds after page load to run the check
    </script>

</body>
</html>