<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Buddy - Dashboard</title>
    
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>

    <header class="header">
        <div class="header-logo">ðŸŒ± Plant Buddy</div>
        <div class="header-user">
            <span>Welcome, <strong sec:authentication="name">User</strong>!</span>
            <form th:action="@{/logout}" method="post" style="display: inline; margin: 0;">
                <button type="submit" class="btn-logout">Logout</button>
            </form>
        </div>
    </header>

    <main class="main-container">

        <div class="content-column">

            <div class="card overdue-card" th:if="${!overdueTasks.isEmpty()}">
                <h2 class="card-title">ðŸš¨ Overdue Care!</h2>
                <ul class="task-list">
                    <li th:each="task : ${overdueTasks}" class="task-item">
                        <div class="task-icon">ðŸ’§</div> <div class="task-info">
                            <span class="plant-name" th:text="${task.plant.plantName}">Plant Name</span>
                            <span class="task-type" th:text="${task.taskType} + ' - Due ' + ${task.dueDate}">Task - Due Date</span>
                        </div>
                        <a th:href="@{/complete-task/{id}(id=${task.taskId})}" class="btn-complete">Complete Now</a>
                    </li>
                </ul>
            </div>
            
            <div class="card" th:if="${overdueTasks.isEmpty()}" style="background-color: var(--green-bg); border: 1px solid var(--green-dark);">
                <h2 class="card-title" style="color: var(--green-dark);">ðŸŒ± All Caught Up!</h2>
                <p>You have no overdue tasks. Your plants are happy!</p>
            </div>

            <div class="card due-soon-card">
                <h2 class="card-title">Tasks Due Soon</h2>
                <ul class="task-list">
                    <th:block th:each="task : ${tasks}">
                        <li th:if="${!task.isCompleted}" class="task-item">
                            <div th:if="${task.taskType == 'WATER'}" class="task-icon task-icon-water">ðŸ’§</div>
                            <div th:if="${task.taskType == 'FERTILIZE'}" class="task-icon task-icon-fertilize">ðŸŒ±</div>
                            
                            <div class="task-info">
                                <span class="plant-name" th:text="${task.plant.plantName}">Plant Name</span>
                                <span class="task-type" th:text="${task.taskType}">Task Type</span>
                            </div>
                            <div class="task-info" style="text-align: right;">
                                <span class="due-date" th:text="'Due ' + ${task.dueDate}">Due Date</span>
                            </div>
                            <a th:href="@{/complete-task/{id}(id=${task.taskId})}" class="btn-complete">Complete</a>
                        </li>
                    </th:block>
                </ul>
            </div>
        </div>

        <div class="sidebar-column">

            <div class="card stats-card">
                <h2 class="card-title" style="margin-bottom: 0.5rem;">Quick Stats</h2>
                <ul>
                    <li>
                        <span class="stats-label">Total Plants</span>
                        <span class="stats-value" th:text="${plants.size()}">0</span>
                    </li>
                    <li>
                        <span class="stats-label">Overdue Tasks</span>
                        <span class="stats-value" th:classappend="${overdueTasks.size() > 0 ? 'overdue' : ''}" th:text="${overdueTasks.size()}">0</span>
                    </li>
                </ul>
            </div>

            <div class="card plant-list-card">
                <h2 class="card-title">
                    My Plants
                    <a th:href="@{/add-plant}" class="btn-add-plant">+ Add Plant</a>
                </h2>
                
                <ul class="task-list"> <li th:each="plant : ${plants}" class="plant-item">
                        
                        <img th:if="${plant.imageUrl != null and plant.imageUrl != ''}" th:src="${plant.imageUrl}" alt="Plant" class="plant-image"/>
                        <div th:if="${plant.imageUrl == null or plant.imageUrl == ''}" class="plant-image-placeholder">ðŸŒ±</div>

                        <div class="plant-info">
                            <span class="plant-name" th:text="${plant.plantName}">Plant Name</span>
                            <div class="plant-freq">
                                <span>ðŸ’§ Every <span th:text="${plant.wateringFrequencyDays}">X</span> days</span>
                            </div>
                        </div>
                        <div class="plant-actions">
                            <a th:href="@{/edit-plant/{id}(id=${plant.plantId})}" class="edit-link">Edit</a>
                            <a th:href="@{/delete-plant/{id}(id=${plant.plantId})}"
                               onclick="return confirm('Are you sure you want to delete this plant?');"
                               class="delete-link">Delete
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        function requestNotificationPermission() {
            if (Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        function showPlantReminders(tasks) {
            if (tasks.length === 0 || Notification.permission !== "granted") {
                return; // Nothing to show or permission denied
            }
            
            tasks.forEach(task => {
                const title = "ðŸŒ± Plant Care Reminder: " + task.plant.plantName;
                const body = `${task.taskType} is due today, ${task.dueDate}.`;
                
                new Notification(title, { body: body });
            });
        }

        requestNotificationPermission();

        setTimeout(() => {
            fetch('/api/due-tasks')
                .then(response => response.ok ? response.json() : [])
                .then(tasks => {
                    showPlantReminders(tasks);
                })
                .catch(error => {
                    console.error('Error fetching reminders:', error);
                });
        }, 3000); 
    </script>
</body>
</html>